# Backend Architecture (`server/`)

This document details the architecture of the Studynaut backend API server.

## Overview

The backend is a Node.js application built with Express.js and TypeScript. Its primary responsibilities are:

*   Providing a RESTful API for the frontend client.
*   Handling user authentication and authorization.
*   Validating incoming data (using Zod).
*   Interacting with the PostgreSQL database (using Drizzle ORM).
*   Enqueuing background jobs for asynchronous processing (using BullMQ).
*   Managing configuration and environment variables.

## Key Technologies

*   **Framework:** Express.js
*   **Language:** TypeScript
*   **ORM:** Drizzle ORM
*   **Validation:** Zod
*   **Authentication:** Passport.js (with local strategy for username/password, session management)
*   **Password Hashing:** bcryptjs
*   **Job Queue:** BullMQ (producer side)
*   **Configuration:** dotenv
*   **Logging:** (To be defined - pino or similar recommended)

## Directory Structure (`server/src`)

```
src/
├── core/
│   ├── auth/         # Authentication middleware, strategies, types
│   ├── config/       # Environment variable loading and validation
│   ├── middleware/   # General Express middleware (error handling, logging, etc.)
│   ├── routes/       # API route definitions (organized by resource)
│   ├── jobs/         # Job definitions and processors (used by the worker)
│   └── utils/        # Common utility functions
├── db/
│   ├── migrations/   # Drizzle migration files
│   ├── schema.ts     # Drizzle schema definitions
│   └── index.ts      # Database connection setup
├── modules/
│   ├── ai/           # AI service, providers, prompts
│   ├── media/        # Media processing logic (uploads, text extraction)
│   ├── notes/        # Notes-related business logic
│   ├── study/        # Study tools logic (quiz, flashcards)
│   └── user/         # User profile logic
├── types/            # Shared backend-specific types
├── worker.ts         # BullMQ worker setup and job processing entry point
└── server.ts         # Express application setup and entry point
```

## Core Components

1.  **`server.ts`:**
    *   Initializes the Express application.
    *   Loads configuration.
    *   Connects to the database.
    *   Sets up core middleware (CORS, body-parser, session, Passport).
    *   Mounts API routers from `core/routes/`.
    *   Sets up global error handling middleware.
    *   Starts the HTTP server.

2.  **`core/config/index.ts`:**
    *   Uses `dotenv` to load environment variables from `.env`.
    *   Uses Zod to validate environment variables, ensuring required ones are present and correctly typed.
    *   Exports a typed configuration object.

3.  **`core/routes/`:**
    *   Organized by resource (e.g., `auth.route.ts`, `notes.route.ts`, `media.route.ts`).
    *   Each file defines an Express `Router`.
    *   Routes utilize controllers or inline handlers to process requests.
    *   Routes are protected using middleware from `core/auth/`. Example: `router.get('/', protect, notesController.getAllNotes);`
    *   A main router (`index.ts` in `core/routes`) aggregates all resource routers and applies a base path (e.g., `/api/v1`).

4.  **`core/auth/`:**
    *   **`protect.middleware.ts`:** Middleware to ensure a user is authenticated before allowing access to a route.
    *   **`passport.config.ts`:** Configures Passport.js strategies (e.g., `passport-local`) and serialization/deserialization.
    *   **`auth.types.ts`:** Defines types like `RequestWithUser` extending Express's Request type.

5.  **`db/`:**
    *   **`index.ts`:** Sets up the Drizzle client and database connection pool.
    *   **`schema.ts`:** Defines all database tables, columns, types, and relations using Drizzle schema syntax.
    *   **`migrations/`:** Contains SQL migration files generated by `drizzle-kit`.

6.  **Modules (`modules/*/`)**
    *   Contain domain-specific logic, often in services (e.g., `ai.service.ts`, `media.service.ts`).
    *   Services encapsulate business rules and interact with the database or external APIs.
    *   Route handlers often delegate tasks to these services.

7.  **`worker.ts`:**
    *   Although part of the `server` package, this runs as a separate process.
    *   Initializes a BullMQ `Worker` instance, connecting to Redis.
    *   Imports and defines processor functions for different job types (defined in `core/jobs/`).
    *   Handles job events (completed, failed).
    *   Requires its own instance of DB connection and potentially service instantiations.

## Request Lifecycle

1.  HTTP request arrives at the Express server.
2.  Goes through global middleware (CORS, body-parser, session).
3.  Matches a route defined in `core/routes/`.
4.  Authentication middleware (`protect`) runs if applied.
5.  Validation middleware (using Zod schemas, potentially) runs.
6.  Route handler/controller executes:
    *   Interacts with services in `modules/`.
    *   Services interact with the DB (`db/`) or external APIs.
    *   May enqueue jobs via BullMQ (`core/jobs/`).
7.  Handler sends a response (JSON) back to the client.
8.  Global error handler catches unhandled errors.

## Error Handling

*   Use `try...catch` blocks in async route handlers and services.
*   Define custom error classes (e.g., `ApiError`, `NotFoundError`) for specific scenarios.
*   A global error handling middleware (`core/middleware/errorHandler.ts`) catches errors, logs them, and sends standardized JSON error responses to the client.
*   Zod validation errors are caught and transformed into user-friendly error responses.

## Key Considerations

*   **State Management:** The API server should be largely stateless, relying on sessions/tokens for authentication state.
*   **Asynchronous Operations:** All I/O operations (DB queries, external API calls, job enqueuing) must be asynchronous (`async/await`).
*   **Security:** Input validation (Zod), authentication checks, CSRF protection (if needed), rate limiting are crucial. 